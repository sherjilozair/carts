pico-8 cartridge // http://www.pico-8.com
version 32
__lua__
left = ‚¨ÖÔ∏è
up = ‚¨ÜÔ∏è
right = ‚û°Ô∏è
down = ‚¨áÔ∏è
jump = üÖæÔ∏è
dash = ‚ùé
prev_jump = false
-- flying_animation = {1: 0.5, 2: 0.5}

accel = 2160
max_speed = 60
max_fall = 120
gravity = 756
jump_timer = 0
jump_advance_timer = 0

function create_cloud(c)
	c.x = rnd(128)
	c.y = rnd(72)
	c.vx = rnd(30)
end

function _init()
	-- poke(0x5f2e, 1)
	-- flip_colors()
	player = {x = 16, y = 88, vx=0, vy=0}
	player.t,player.f,player.s=0,1,4 --tick,frame,step
	-- player
	player.walk = {16, 16, 17, 17, 18, 18, 19, 19}
	player.fly = {2, 2, 3, 3, 4, 4}
	player.idle = {16}
	player.glide = {3}
	player.sp = player.fly
	player.flip = false
	function player:set_anim(sp)
		if self.sp ~= sp then
			self.sp = sp
			self.f = 1
		end
	end

	-- cloud
	clouds = {}
	for i=1,10 do
		clouds[i] = {}
		create_cloud(clouds[i])
	end
end

function _update60()
	local ground = player.y == 88
	input_x = btn(left) and -1 or btn(right) and 1 or 0
	player.vx = appr(player.vx, input_x * max_speed, accel/60)
	
	if (player.vx < 0) player.flip = true
	if (player.vx > 0) player.flip = false

	if ground then
		if abs(player.vx) > 0.01 then
			player:set_anim(player.walk)
		else
			player:set_anim(player.idle)
		end
	else
		if player.vy > 0 then
			player:set_anim(player.glide)
		else
			player:set_anim(player.fly)
		end
	end
	
	if btn(jump) and not prev_jump then
		jump_advance_timer = 0.1
	end
	prev_jump = btn(jump)
	jump_advance_timer = max(0, jump_advance_timer - 1/60)

	if jump_advance_timer > 0 and jump_timer <= 0 then 
		if ground then 
			player.vy = -150
		else
			player.vy = -120
		end
		jump_timer = 0.35

	end

	jump_timer = max(0, jump_timer - 1/60)
		
	grv = gravity
	if (abs(player.vy) < 15) grv *= 0.5
	if not ground then
		player.vy = min(player.vy + grv / 60, max_fall)
	end
	player.x += player.vx / 60
	player.y += player.vy / 60
	if player.y > 88 then
		player.y = 88 
		player.vy = 0
	end
	animate(player)

	-- clouds
	for cloud in all(clouds) do
		cloud.x = cloud.x - cloud.vx / 60
		if cloud.x < -16 then
			create_cloud(cloud)
			cloud.x = 128
		end
	end
end

function _draw()
	cls(12)
	map(0, 0)
	for cloud in all(clouds) do
		spr(23, cloud.x, cloud.y, 2, 2)
	end
	spr(player.sp[player.f],player.x,player.y, 1, 1, player.flip)

	print("".. player.vy)

end





--animate an object
function animate(o)
 o.t=(o.t+1)%o.s --tick fwd
 if (o.t==0) o.f=o.f%#o.sp+1
end

function flip_colors()
	p8ap=bxor(p8ap,128)
	for i=0,15 do 
		pal(i,i+p8ap,1) 
	end
end
menuitem(1, "palette", flip_colors)
-->8
function appr(val,target,amount)
 return val > target 
 	and max(val - amount, target) 
 	or min(val + amount, target)
end

__gfx__
000000000000000000000000000000000000ff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000ff000000ff00fff0ff00000ffff00000ff0000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000ffff0ff0ffff0fffffff0000ff1f8ff0ffff000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000ff1f8fffff1f80ffff1f800fffff0fffff1f800000000000000000000000000000000000000000000000000000000000000000000000000000000
0007700000fffff0fffffff000fffff005ffff00fffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000
0070070005ffff0005ffff0005ffff0055ffff000fffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000555fff00555fff00555fff0005fff000555fff0000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000202000000200000002000000ff00000020200000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000ff0000000000000000000000000000000000000066000777760000000000000000000000000000000000000000000000000000000000
0000ff000000ff00000ffff00000ff00000000000000000000000000066677706777677007770770000000000000000000000000000000000000000000000000
000ffff0000ffff0000ff1f8000ffff0000000000000000000000000677777667776777777777777000000000000000000000000000000000000000000000000
000ff1f8000ff1f800fffff0000ff1f8000000000000000000000000677776777776777777777777000000000000000000000000000000000000000000000000
00fffff000fffff005ffff0000fffff0000000000000000000000000677776777776777777777777000000000000000000000000000000000000000000000000
05ffff0005ffff00555fff0005ffff00000000000000000000000000667776777767777777777777000000000000000000000000000000000000000000000000
555fff00555fff0000202000555fff00000000000000000000000000066776777767777707707770000000000000000000000000000000000000000000000000
00202000020200000000000000020200000000000000000000000000006677666767777000000000000000000000000000000000000000000000000000000000
00222222222222222222220000000000000000000000000000000000000666000666600000000000000000000000000000000000000000000000000000000000
02555552555555525555552000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
25333352333333523333335200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
23333352333333523333335200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22222222222222222222222200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
25525555555255555552555200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
23523333335233333352335200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
23523333335233333352335200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22222222000000002222222200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
25555552000000005555555200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
23333352000000003333335200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
23333352000000003333335200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22222222000000002222222200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
25525555000000005552555200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
23523333000000003352335200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
23523333000000003352335200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000000000000000000000000000000000000000000000000000000000010101000000000000000000000000000101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2021212121212121212121212121212200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3021212121212121212121212121213200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3021212121212121212121212121213200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3021212121212121212121212121213200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3021212121212121212121212121213200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
